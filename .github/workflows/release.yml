name: BCLD FLOW

on:
  push:
    branches:
      - main
jobs:
  vendorless-release:
    runs-on: ubuntu-22.04
    environment: release
    container:
      image: ubuntu:jammy
      options: --privileged
      env:
        BCLD_APP: ${{ vars.BCLD_APP }}
        BCLD_CFG_EDIT: ${{ vars.BCLD_CFG_EDIT }}
        BCLD_MODEL: ${{ vars.BCLD_MODEL }}
        BCLD_SECRET: ${{ secrets.BCLD_SECRET }}
        CLEAN_BOOTSTRAP: ${{ vars.CLEAN_BOOTSTRAP }}
        NULLFIX: ${{ vars.NULLFIX }}
      volumes:
        - /dev:/dev:ro
        - /run:/run:rw
        - /var/docker.sock:/var/docker.sock:ro
        - ${{ github.workspace }}:/project:rw
    steps:
    - name: Set up Git
      uses: actions/setup-git@v2
      with:
        version: '2.18.0'
    - name: Checkout repository and submodules
      uses: actions/checkout@v2
      with:
        submodules: recursive
        fetch-depth: 0
    - name: Install dependencies
      run: |
        /usr/bin/apt-get update
        /usr/bin/apt-get upgrade -y
        /usr/bin/apt-get install -y $(cat /project/config/packages/BUILD)
    - name: Run BCLD build script through BATS
      run: |
        /usr/bin/bash -c 'BCLD_MODEL=release ./test/BCLD-BATS.sh'
    - name: Upload artifacts
      uses: actions/upload-artifact@v2
      with:
        name: vendorless-bcld
        path: /project/artifacts/*.img

